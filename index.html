<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMART NYUKI - Professional Dashboard</title>

  <!-- MQTT.js CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Chart.js CDN for weight history chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #fffaf0;
      --card: #ffffff;
      --text: #3c2f2f;
      --accent: #d97706;
      --accent-dark: #b45309;
      --progress-bg: #fef3c7;
      --progress-fill: #ca8a04;
      --honeycomb: #f59e0b;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --border: #dee2e6;
    }
    [data-theme="dark"] {
      --bg: #1e1e1e;
      --card: #2d2d2d;
      --text: #f5f5f5;
      --accent: #fbbf24;
      --accent-dark: #d97706;
      --progress-bg: #4b3f1a;
      --progress-fill: #fbbf24;
      --honeycomb: #b45309;
      --shadow: 0 4px 12px rgba(0,0,0,0.4);
      --border: #495057;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 25px 25px, var(--honeycomb) 2px, transparent 3px),
        radial-gradient(circle at 75px 75px, var(--honeycomb) 2px, transparent 3px);
      background-size: 100px 100px;
      transition: all 0.3s ease;
    }
    .login-container {
      max-width: 420px;
      margin: 80px auto;
      padding: 40px;
      background: var(--card);
      border-radius: 24px;
      box-shadow: var(--shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .login-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,215,0,0.15) 0%, transparent 70%);
      pointer-events: none;
    }
    .login-container h2 {
      margin-bottom: 30px;
      color: var(--accent);
      font-size: 2rem;
    }
    .login-form input {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border: 2px solid var(--accent);
      border-radius: 8px;
      font-size: 1.1rem;
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(4px);
    }
    .login-form button {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s;
    }
    .login-form button:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }

    /* Dashboard styles */
    .dashboard {
      display: none;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 40px;
    }
    h1 {
      color: var(--accent);
      margin: 0;
      font-size: 2.5rem;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-outline {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }
    .btn-outline:hover {
      background: var(--accent);
      color: white;
    }
    .hives-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .hive-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      transition: transform 0.25s ease;
    }
    .hive-card:hover {
      transform: translateY(-6px);
    }
    .hive-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .hive-title {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 600;
    }
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .status-live { background: #d4edda; color: #155724; }
    .status-offline { background: #f8d7da; color: #721c24; }
    .metric {
      font-size: 2.2rem;
      font-weight: 700;
      margin: 12px 0;
      color: var(--accent);
    }
    .progress-bar {
      height: 24px;
      background: var(--progress-bg);
      border-radius: 12px;
      overflow: hidden;
      margin: 12px 0;
    }
    .progress-fill {
      height: 100%;
      background: var(--progress-fill);
      transition: width 0.6s ease;
    }
    .last-update {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 8px;
    }
    .harvest-btn {
      width: 100%;
      padding: 14px;
      font-size: 1.1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 16px;
    }
    .harvest-btn:hover {
      background: var(--accent-dark);
    }
    .status-msg {
      margin-top: 12px;
      font-weight: 500;
      text-align: center;
    }
    .success-msg { color: #198754; }
    .error-msg { color: #dc3545; }
    .chart-container {
      margin-top: 40px;
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .notification-permission {
      text-align: center;
      margin: 20px 0;
      color: #6c757d;
      font-style: italic;
    }
  </style>
</head>
<body data-theme="light">

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <h2>SMART NYUKI Login</h2>
    <div class="login-form">
      <input type="text" id="username" placeholder="Username" autocomplete="off">
      <input type="password" id="password" placeholder="Password" autocomplete="off">
      <button onclick="login()">Login</button>
    </div>
  </div>

  <!-- Main Dashboard (hidden until login) -->
  <div id="dashboard" class="dashboard">
    <header>
      <h1>üêù SMART NYUKI - Professional Dashboard</h1>
    </header>

    <div class="controls">
      <button class="btn btn-outline" onclick="toggleTheme()">Toggle Dark Mode</button>
    </div>

    <div class="hives-grid" id="hivesGrid"></div>

    <!-- Weight History Chart -->
    <div class="chart-container">
      <h3>Hive 1 Weight History (Last 30 Readings)</h3>
      <canvas id="weightChart" height="200"></canvas>
    </div>

    <div class="notification-permission" id="notificationStatus">
      Click anywhere to enable notifications for weight changes & harvest
    </div>
  </div>

  <script>
    // ==================== Simple Login ====================
    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (username === 'trevor' && password === '1') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        renderHives(); // Show dashboard
      } else {
        alert("Incorrect username or password!");
      }
    }

    // ==================== Hive Data ====================
    const hives = [
      { id: 1, name: "Hive 1 (Live)", weight: 0, level: 0, lastUpdate: "Waiting...", status: "live", live: true },
      { id: 2, name: "Hive 2", weight: 0, level: 0, lastUpdate: "Offline", status: "offline", live: false },
      { id: 3, name: "Hive 3", weight: 0, level: 0, lastUpdate: "Offline", status: "offline", live: false },
      { id: 4, name: "Hive 4", weight: 0, level: 0, lastUpdate: "Offline", status: "offline", live: false }
    ];

    // ==================== Render Hives ====================
    function renderHives() {
      const grid = document.getElementById('hivesGrid');
      grid.innerHTML = '';

      hives.forEach(hive => {
        const card = document.createElement('div');
        card.className = 'hive-card';
        card.innerHTML = `
          <div class="hive-header">
            <h2 class="hive-title">${hive.name}</h2>
            <span class="status-badge status-${hive.status}">
              ${hive.status === 'live' ? 'LIVE' : 'Offline'}
            </span>
          </div>
          <div class="metric">Weight: <span id="weight-${hive.id}">${hive.weight.toFixed(2)}</span> kg</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-${hive.id}" style="width: ${hive.level}%"></div>
          </div>
          <div><strong>${hive.level}%</strong> full</div>
          <div class="last-update">Last update: <span id="lastUpdate-${hive.id}">${hive.lastUpdate}</span></div>
          <button class="harvest-btn" onclick="sendHarvest(${hive.id})">
            HARVEST HONEY
          </button>
          <div class="status-msg" id="status-${hive.id}"></div>
        `;
        grid.appendChild(card);
      });
    }

    // ==================== Theme Toggle ====================
    function toggleTheme() {
      document.body.setAttribute('data-theme', 
        document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'
      );
    }

    // ==================== MQTT Connection ====================
    const mqttOptions = {
      connectTimeout: 5000,
      clientId: 'web-dashboard-' + Math.random().toString(16).substr(2, 8),
      username: '',
      password: '',
      keepalive: 60,
      clean: true,
    };

    const client = mqtt.connect('ws://broker.hivemq.com:8000/mqtt', mqttOptions);;

    // Weight history for chart (last 30 points)
    const weightHistory = [];
    const labels = [];

    let weightChart;

    // Initialize Chart.js
    function initChart() {
      const ctx = document.getElementById('weightChart').getContext('2d');
      weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Weight (kg)',
            data: weightHistory,
            borderColor: 'rgba(13, 110, 253, 1)',
            backgroundColor: 'rgba(13, 110, 253, 0.2)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    initChart();

    client.on('connect', () => {
      console.log('MQTT Connected');
      client.subscribe('smartnyuki/hive/1/weight');
    });

    client.on('message', (topic, message) => {
      const msg = message.toString().trim();

      if (topic === 'smartnyuki/hive/1/weight') {
        const weight = parseFloat(msg) || 0;
        const level = Math.min(100, Math.max(0, Math.round((weight / 300) * 100)));
        const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Update Hive 1
        hives[0].weight = weight;
        hives[0].level = level;
        hives[0].lastUpdate = new Date().toLocaleString();

        // Update chart
        weightHistory.push(weight);
        labels.push(now);
        if (weightHistory.length > 30) {
          weightHistory.shift();
          labels.shift();
        }
        weightChart.update();

        // Notification: significant weight change
        if (weightHistory.length > 1) {
          const change = Math.abs(weight - weightHistory[weightHistory.length-2]);
          if (change > 10) {
            notify(`Weight changed significantly: ${weight.toFixed(2)} kg`);
          }
        }

        // Notification: reached 50%+
        if (level >= 50 && hives[0].level < 50) {
          notify("Hive 1 is ready for harvest! (‚â•50%)");
        }

        // Re-render
        renderHives();
      }
    });

    // ==================== Send Harvest Command ====================
    function sendHarvest(hiveId) {
      if (confirm(`Confirm harvest for Hive ${hiveId}?`)) {
        client.publish('smartnyuki/hive/1/harvest', 'OPEN', { qos: 1 }, (err) => {
          const status = document.getElementById(`status-${hiveId}`);
          status.textContent = err ? "Failed to send" : "Command sent!";
          status.style.color = err ? '#dc3545' : '#198754';

          // Notification on success
          if (!err) notify("Harvest command sent to Hive 1!");

          setTimeout(() => status.textContent = '', 6000);
        });
      }
    }

    // ==================== Browser Notifications ====================
    function notify(message) {
      if ("Notification" in window) {
        if (Notification.permission === "granted") {
          new Notification("SMART NYUKI", { body: message, icon: "https://img.icons8.com/emoji/96/000000/honey-pot.png" });
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission().then(permission => {
            if (permission === "granted") {
              new Notification("SMART NYUKI", { body: message, icon: "https://img.icons8.com/emoji/96/000000/honey-pot.png" });
            }
          });
        }
      }
    }

    // Request notification permission on first interaction
    document.body.addEventListener('click', () => {
      if (Notification.permission === "default") {
        Notification.requestPermission();
      }
    }, { once: true });
  </script>
</body>
</html>